# 게임 모드 시스템

> V1.9.0 패치 - 극악 난이도 및 보스 시스템 추가

---

## 목차

1. [개요](#개요)
2. [AI 대전 모드](#ai-대전-모드)
3. [1vs1 대전 모드](#1vs1-대전-모드)
4. [UI 흐름](#ui-흐름)
5. [V1.5.1 변경 내역](#v151-변경-내역)

---

## 개요

게임 시작 전 게임 모드를 선택할 수 있습니다.

| 모드 | 상태 | 설명 |
|------|------|------|
| AI 대전 | 구현됨 | AI와 대전, 난이도 선택 가능 |
| 1vs1 대전 | 구현됨 | 다른 플레이어와 실시간 대전 |

---

## AI 대전 모드

### 난이도 선택

AI 대전 시 5가지 난이도 중 하나를 선택할 수 있습니다.

| 난이도 | 추천 대상 | 특징 |
|--------|----------|------|
| 쉬움 | 초보자 | 느린 AI |
| 중간 | 일반 플레이어 | 빠른 AI, 기지 HP 증가 |
| 어려움 | 숙련자 | 매우 빠르고 공격적인 AI |
| 극악 | 도전자 | 보스 페이즈 시스템, 본진 파괴 후 보스 출현 |
| 보스 테스트 | 테스트용 | 보스 즉시 출현 (밸런스 테스트용) |

### 난이도별 상세 설정

#### 쉬움 (Easy)

| 항목 | 값 | 설명 |
|------|-----|------|
| 골드 수입 | 4/초 | 플레이어와 동일 |
| 행동 주기 | 5초 | 의사결정 간격 |
| 행동 확률 | 60% | 턴마다 행동할 확률 |
| 지원 유닛 최소 | 3마리 | 유지하려는 지원 유닛 수 |
| 금광부 생산 확률 | 20% | 조건 충족 시 |
| 기사 생산 확률 | 25% | 조건 충족 시 |
| 궁수 생산 확률 | 30% | 조건 충족 시 |
| 채집꾼 생산 확률 | 20% | 약초 채집 |
| 광부 생산 확률 | 20% | 돌 채집 |
| 초기 골드 | 100 | 게임 시작 시 |
| 적 기지 HP | 1000 | 기본값 |

**특징**:
- 느린 의사결정으로 대응 시간 충분
- 고급 유닛 생산 확률 낮음
- 초보자가 게임 시스템을 익히기 좋음

---

#### 중간 (Normal)

| 항목 | 값 | 설명 |
|------|-----|------|
| 골드 수입 | 4/초 | 플레이어와 동일 |
| 행동 주기 | 3초 | 빠른 의사결정 |
| 행동 확률 | 80% | 높은 행동 확률 |
| 지원 유닛 최소 | 4마리 | 더 많은 자원 채집 |
| 금광부 생산 확률 | 40% | 증가 |
| 기사 생산 확률 | 45% | 증가 |
| 궁수 생산 확률 | 50% | 증가 |
| 채집꾼 생산 확률 | 35% | 약초 채집 |
| 광부 생산 확률 | 35% | 돌 채집 |
| 초기 골드 | 120 | 20 보너스 |
| 적 기지 HP | 1200 | 200 증가 |

**특징**:
- 빠른 의사결정으로 적극적인 유닛 생산
- 고급 유닛(기사, 궁수) 자주 등장
- 채집꾼/광부도 생산
- 약초 판매로 추가 골드 획득
- 전략적 플레이 필요

---

#### 어려움 (Hard)

| 항목 | 값 | 설명 |
|------|-----|------|
| 골드 수입 | 4/초 | 플레이어와 동일 |
| 행동 주기 | 2.5초 | 빠른 의사결정 |
| 행동 확률 | 85% | 높은 행동 확률 |
| 지원 유닛 최소 | 5마리 | 강력한 자원 수급 |
| 금광부 생산 확률 | 50% | 매우 높음 |
| 기사 생산 확률 | 55% | 매우 높음 |
| 궁수 생산 확률 | 60% | 매우 높음 |
| 채집꾼 생산 확률 | 45% | 약초 채집 |
| 광부 생산 확률 | 45% | 돌 채집 |
| 초기 골드 | 120 | 20 보너스 |
| 적 기지 HP | 1500 | 500 증가 |

**특징**:
- 빠른 의사결정으로 강력한 압박
- 고급 유닛 대량 생산
- 채집꾼/광부로 다양한 자원 확보
- 약초 판매로 추가 골드 획득
- 초기 골드 보너스로 빠른 시작
- 기지 체력 50% 증가로 공략 난이도 상승
- 숙련된 전략과 빠른 대응 필수

---

#### 극악 (Nightmare) - V1.9.0

| 항목 | 값 | 설명 |
|------|-----|------|
| 골드 수입 | 6/초 | 플레이어보다 50% 높음 |
| 행동 주기 | 1.5초 | 매우 빠른 의사결정 |
| 행동 확률 | 98% | 거의 모든 턴 행동 |
| 지원 유닛 최소 | 6마리 | 강력한 자원 수급 |
| 금광부 생산 확률 | 70% | 매우 높음 |
| 기사 생산 확률 | 75% | 매우 높음 |
| 궁수 생산 확률 | 80% | 매우 높음 |
| 채집꾼 생산 확률 | 60% | 약초 채집 |
| 광부 생산 확률 | 60% | 돌 채집 |
| 힐러 생산 확률 | 55% | 회복 지원 |
| 마법사 생산 확률 | 50% | 범위 공격 |
| 초기 골드 | 200 | 100 보너스 |
| 적 기지 HP | 2000 | 기본의 2배 |

**페이즈 시스템**:

극악 난이도는 **2단계 페이즈** 시스템을 사용합니다.

| 페이즈 | 조건 | 목표 |
|--------|------|------|
| 페이즈 1 | 게임 시작 | 적 본진 파괴 |
| 페이즈 2 | 적 본진 HP ≤ 0 | 보스 처치 |

**페이즈 2 전환**:
1. 적 본진을 파괴하면 페이즈 2가 시작됩니다
2. 파괴된 적 본진 위치에서 **보스**가 출현합니다
3. 보스를 처치해야 승리합니다
4. 보스가 아군 본진을 파괴하면 패배합니다

**승리/패배 조건**:

| 조건 | 결과 |
|------|------|
| 보스 처치 | 승리 |
| 아군 본진 파괴 | 패배 |
| 시간 종료 + 보스 생존 | 패배 |
| 시간 종료 + 보스 처치됨 | 승리 |

**특징**:
- 1분마다 대량 발생 (풀 조합)
- 한 번에 최대 4유닛 동시 소환
- 어려움보다 훨씬 강력한 AI
- 본진 파괴가 끝이 아닌 시작
- 보스 처치를 위한 강력한 군사력 필요

---

#### 보스 테스트 (Boss Test) - V1.9.0

| 항목 | 값 | 설명 |
|------|-----|------|
| 골드 수입 | 10/초 | 테스트용 높은 수입 |
| 행동 주기 | 10초 | 거의 행동 안 함 |
| 행동 확률 | 10% | 매우 낮음 |
| 초기 골드 | 1000 | 테스트용 높은 초기 자금 |
| 적 기지 HP | 1 | 즉시 파괴됨 |

**용도**:
- 보스 스탯 밸런스 테스트
- 보스 전투 연습
- 검병 1마리로 적 본진 파괴 → 보스 즉시 출현

---

### AI 의사결정 로직

AI는 다음 우선순위로 행동합니다:

```
[약초 판매] (행동 확률과 무관)
- 약초 10개 이상 보유 시 → 30골드로 판매

[유닛 생산] (행동 확률 적용)
1. 초반: 지원 유닛이 최소 수보다 적으면
   → 60% 나무꾼 / 20% 채집꾼 / 20% 광부 중 선택
2. 중후반: 지원 유닛 충분 시 전투 유닛 우선 (70-85% 확률)
   → 기사 → 궁수 → 검병 순으로 시도
3. 추가 지원 유닛 (낮은 확률)
   → 금광부, 채집꾼, 광부
4. 폴백: 검병 생산
```

### AI 자원 관리

| 행동 | 조건 | 효과 |
|------|------|------|
| 약초 판매 | 약초 ≥ 10 | +30 골드 |
| 전투 유닛 우선 | 지원 유닛 충분 | 70-85% 확률로 전투 유닛 |

---

### 난이도별 예상 게임 양상

| 난이도 | 초반 (0~3분) | 중반 (3~7분) | 후반 (7~10분) |
|--------|-------------|-------------|---------------|
| 쉬움 | 느린 유닛 생산 | 검병 위주 | 소수 궁수 |
| 중간 | 빠른 유닛 생산 | 검병+궁수+채집꾼 혼합 | 기사 대량 등장 |
| 어려움 | 매우 빠른 유닛 생산 | 다양한 유닛 대량 | 기사+궁수 압도적 |

### 난이도별 적 기지 HP

| 난이도 | 적 기지 HP | 공략 난이도 |
|--------|-----------|------------|
| 쉬움 | 1000 | 기본 |
| 중간 | 1200 | +20% |
| 어려움 | 1500 | +50% |

---

## 1vs1 대전 모드

> V1.5.1에서 실시간 상태 동기화 완료. 멀티플레이어 대전 가능.

### 개요

실시간으로 다른 플레이어와 대전하는 모드입니다.

### 구현 현황

| 기능 | 상태 | 설명 |
|------|------|------|
| WebSocket 서버 | 완료 | Node.js + ws 기반 서버 |
| 플레이어 연결/해제 | 완료 | 연결 관리 및 정리 |
| 초대 코드 시스템 | 완료 | 방 생성 및 초대 코드로 입장 |
| 게임 방 관리 | 완료 | GameRoom 클래스 구현 |
| 서버 게임 루프 | 완료 | 60fps setInterval 기반 |
| 클라이언트 연동 | 완료 | WebSocket 클라이언트 및 상태 관리 |
| 상태 동기화 | 완료 | 서버 권위 모델 기반 실시간 동기화 |
| 멀티플레이어 렌더링 | 완료 | 서버 상태 기반 캔버스 렌더링 |
| 진영 배정 | 완료 | 방장 왼쪽, 참가자 오른쪽 배정 |

### 기술 스택

| 구성요소 | 기술 |
|---------|------|
| 서버 | Node.js |
| 통신 | WebSocket |
| 동기화 | 서버 권위 모델 |

### 아키텍처

```
┌─────────────┐     WebSocket      ┌─────────────┐
│  Player 1   │◄──────────────────►│   Server    │
│  (Browser)  │                    │  (Node.js)  │
└─────────────┘                    └──────┬──────┘
                                          │
                                          │ WebSocket
                                          ▼
                                   ┌─────────────┐
                                   │  Player 2   │
                                   │  (Browser)  │
                                   └─────────────┘
```

### 매칭 시스템 (초대 코드 방식)

**방 만들기**
1. "방 만들기" 버튼 클릭
2. 6자리 초대 코드 생성
3. 초대 코드를 상대방에게 공유
4. 상대방 입장 후 게임 시작

**방 입장하기**
1. 상대방이 공유한 초대 코드 입력
2. "입장" 버튼 클릭
3. 방에 입장하면 자동으로 게임 시작

**진영 배정**
- 방장(방을 만든 플레이어): 왼쪽 진영 (파란색)
- 참가자(방에 입장한 플레이어): 오른쪽 진영 (빨간색)

### 게임 규칙

| 항목 | 값 |
|------|-----|
| 게임 시간 | 10분 |
| 양측 골드 수입 | 기본 4/초 (업그레이드로 증가 가능) |
| 초기 자원 | 골드 100 (동일) |
| 승리 조건 | 적 기지 파괴 또는 시간 종료 시 HP 우위 |

### 동기화 전략

**서버 권위 모델**
- 모든 게임 로직은 서버에서 실행
- 클라이언트는 입력만 전송
- 치팅 방지

**상태 동기화**
- 전체 상태: 게임 시작 시
- 델타 업데이트: 100ms마다
- 중요 이벤트: 즉시 전송

### 통신 메시지

**클라이언트 → 서버**
| 메시지 | 설명 |
|--------|------|
| CREATE_ROOM | 새 방 생성 요청 |
| JOIN_ROOM | 초대 코드로 방 입장 |
| LEAVE_ROOM | 방 나가기 |
| SPAWN_UNIT | 유닛 생산 요청 |
| BUILD_WALL | 벽 건설 요청 |
| UPGRADE_BASE | 기지 업그레이드 요청 |
| SELL_HERB | 약초 판매 요청 |

**서버 → 클라이언트**
| 메시지 | 설명 |
|--------|------|
| ROOM_CREATED | 방 생성 완료 (초대 코드 포함) |
| ROOM_JOINED | 방 입장 완료 |
| GAME_START | 게임 시작 |
| GAME_STATE | 전체 게임 상태 (100ms마다) |
| GAME_OVER | 게임 종료 결과 |
| ERROR | 오류 메시지 |

---

## UI 흐름

### 이전 (V1.3.x)

```
메인 메뉴 → [게임 시작] → 게임 화면
```

### 현재 (V1.5.1)

```
메인 메뉴 → [게임 시작] → 모드 선택
                              │
                              ├─ [AI 대전] → 난이도 선택 → 게임 화면
                              │                  │
                              │                  ├─ 쉬움
                              │                  ├─ 중간
                              │                  ├─ 어려움
                              │                  ├─ 극악 (보스 페이즈)
                              │                  └─ 보스 테스트
                              │
                              └─ [1vs1 대전] → 로비 화면 → 게임 화면
                                                 │
                                                 ├─ 이름 입력
                                                 ├─ 서버 연결
                                                 ├─ 방 만들기 (초대 코드 생성)
                                                 └─ 방 입장 (초대 코드 입력)
```

---

## 버전별 변경 내역

### V1.9.0 변경 내역

**극악 난이도 추가**
- 2단계 페이즈 시스템 (본진 파괴 → 보스 출현)
- 적 본진 HP 2000
- AI 골드 수입 6/초, 행동 확률 98%
- 1분마다 대량 발생 (풀 조합)
- 한 번에 최대 4유닛 소환

**보스 유닛 추가**
- HP: 2000
- 공격력: 100 (AOE)
- AOE 반경: 80픽셀
- 이동속도: 0.5 (매우 느림)
- 파괴된 적 본진 위치에서 출현

**보스 테스트 난이도 추가**
- 적 기지 HP 1 (즉시 파괴)
- 보스 밸런스 테스트용

---

### V1.6.1 변경 내역

**벽 타겟팅 시스템 개선**
- 유닛이 벽을 본진보다 먼저 공격
- 공격 중인 벽이 파괴될 때까지 타겟 유지
- 공격 중 다른 유닛에게 공격받으면 반격 후 벽으로 복귀

**기지 업그레이드 시스템 개선**
- 업그레이드 비용 레벨당 1.5배 증가
- 업그레이드 시 골드 수입 +1/초 추가
- UI에 현재 레벨 및 다음 업그레이드 비용 표시

---

### V1.6.0 변경 내역

**맵 및 카메라 개선**
- 마우스 스크롤 줌 기능 추가 (0.5x ~ 2x)
- 맵 크기 확장 (3000x2000 → 4000x2400)

**자원 시스템 조정**
- 약초 재생성: 45초 → 30초
- 나무 재생성: 60초 → 40초
- 금광산 재생성: 60초 → 40초

---

### V1.5.1 변경 내역

**해결된 문제**

| 문제 | 해결 내용 |
|------|----------|
| 상대방 상태 미표시 | 서버 상태(`NetworkGameState`) 기반 렌더링으로 전환 |
| 유닛이 움직이지 않음 | 로컬 게임 루프 비활성화, 서버 권위 모델 적용 |
| 맵 구조 불일치 | 서버에서 생성한 자원 노드 위치 동기화 |
| 진영 배정 미작동 | 방장은 왼쪽, 참가자는 오른쪽으로 카메라 초기 위치 설정 |

**기술적 변경사항**

1. **멀티플레이어 렌더링 분리**
   - `renderMultiplayer()` 함수 추가
   - `drawNetworkUnit()`, `drawNetworkWall()` 함수 추가
   - 서버 상태 기반 미니맵 렌더링

2. **상태 관리 개선**
   - `useMultiplayerGameState` 훅 추가
   - 멀티플레이어 모드에서 로컬 게임 루프 비활성화
   - UI 컴포넌트들이 서버 상태 참조하도록 수정

3. **액션 처리**
   - 유닛 소환, 벽 건설, 업그레이드 등 모든 액션이 서버로 전송
   - 진영 기반 건설 영역 제한

4. **초대 코드 시스템**
   - 6자리 초대 코드로 방 입장
   - 매칭 대기열 대신 직접 초대 방식

---

## 다음 문서

- [게임플레이 가이드](./GAMEPLAY.md) - 기본 조작 및 전략
- [유닛 가이드](./UNITS.md) - 모든 유닛의 상세 정보
- [게임 밸런스](./BALANCE.md) - 수치 및 AI 분석
