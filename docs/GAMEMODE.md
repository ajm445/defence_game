# 게임 모드 시스템

> V1.5.0 패치 - 1vs1 네트워크 멀티플레이어 추가

---

## 목차

1. [개요](#개요)
2. [AI 대전 모드](#ai-대전-모드)
3. [1vs1 대전 모드](#1vs1-대전-모드)
4. [UI 흐름](#ui-흐름)
5. [알려진 문제](#알려진-문제)

---

## 개요

게임 시작 전 게임 모드를 선택할 수 있습니다.

| 모드 | 상태 | 설명 |
|------|------|------|
| AI 대전 | 구현됨 | AI와 대전, 난이도 선택 가능 |
| 1vs1 대전 | 개발중 | 다른 플레이어와 실시간 대전 |

---

## AI 대전 모드

### 난이도 선택

AI 대전 시 3가지 난이도 중 하나를 선택할 수 있습니다.

| 난이도 | 추천 대상 | 특징 |
|--------|----------|------|
| 쉬움 | 초보자 | 느린 AI |
| 중간 | 일반 플레이어 | 빠른 AI, 기지 HP 증가 |
| 어려움 | 숙련자 | 매우 빠르고 공격적인 AI |

### 난이도별 상세 설정

#### 쉬움 (Easy)

| 항목 | 값 | 설명 |
|------|-----|------|
| 골드 수입 | 4/초 | 플레이어와 동일 |
| 행동 주기 | 5초 | 의사결정 간격 |
| 행동 확률 | 60% | 턴마다 행동할 확률 |
| 지원 유닛 최소 | 3마리 | 유지하려는 지원 유닛 수 |
| 금광부 생산 확률 | 20% | 조건 충족 시 |
| 기사 생산 확률 | 25% | 조건 충족 시 |
| 궁수 생산 확률 | 30% | 조건 충족 시 |
| 채집꾼 생산 확률 | 20% | 약초 채집 |
| 광부 생산 확률 | 20% | 돌 채집 |
| 초기 골드 | 100 | 게임 시작 시 |
| 적 기지 HP | 1000 | 기본값 |

**특징**:
- 느린 의사결정으로 대응 시간 충분
- 고급 유닛 생산 확률 낮음
- 초보자가 게임 시스템을 익히기 좋음

---

#### 중간 (Normal)

| 항목 | 값 | 설명 |
|------|-----|------|
| 골드 수입 | 4/초 | 플레이어와 동일 |
| 행동 주기 | 3초 | 빠른 의사결정 |
| 행동 확률 | 80% | 높은 행동 확률 |
| 지원 유닛 최소 | 4마리 | 더 많은 자원 채집 |
| 금광부 생산 확률 | 40% | 증가 |
| 기사 생산 확률 | 45% | 증가 |
| 궁수 생산 확률 | 50% | 증가 |
| 채집꾼 생산 확률 | 35% | 약초 채집 |
| 광부 생산 확률 | 35% | 돌 채집 |
| 초기 골드 | 120 | 20 보너스 |
| 적 기지 HP | 1200 | 200 증가 |

**특징**:
- 빠른 의사결정으로 적극적인 유닛 생산
- 고급 유닛(기사, 궁수) 자주 등장
- 채집꾼/광부도 생산
- 약초 판매로 추가 골드 획득
- 전략적 플레이 필요

---

#### 어려움 (Hard)

| 항목 | 값 | 설명 |
|------|-----|------|
| 골드 수입 | 4/초 | 플레이어와 동일 |
| 행동 주기 | 2.5초 | 빠른 의사결정 |
| 행동 확률 | 85% | 높은 행동 확률 |
| 지원 유닛 최소 | 5마리 | 강력한 자원 수급 |
| 금광부 생산 확률 | 50% | 매우 높음 |
| 기사 생산 확률 | 55% | 매우 높음 |
| 궁수 생산 확률 | 60% | 매우 높음 |
| 채집꾼 생산 확률 | 45% | 약초 채집 |
| 광부 생산 확률 | 45% | 돌 채집 |
| 초기 골드 | 120 | 20 보너스 |
| 적 기지 HP | 1500 | 500 증가 |

**특징**:
- 빠른 의사결정으로 강력한 압박
- 고급 유닛 대량 생산
- 채집꾼/광부로 다양한 자원 확보
- 약초 판매로 추가 골드 획득
- 초기 골드 보너스로 빠른 시작
- 기지 체력 50% 증가로 공략 난이도 상승
- 숙련된 전략과 빠른 대응 필수

---

### AI 의사결정 로직

AI는 다음 우선순위로 행동합니다:

```
[약초 판매] (행동 확률과 무관)
- 약초 10개 이상 보유 시 → 30골드로 판매

[유닛 생산] (행동 확률 적용)
1. 초반: 지원 유닛이 최소 수보다 적으면
   → 60% 나무꾼 / 20% 채집꾼 / 20% 광부 중 선택
2. 중후반: 지원 유닛 충분 시 전투 유닛 우선 (70-85% 확률)
   → 기사 → 궁수 → 검병 순으로 시도
3. 추가 지원 유닛 (낮은 확률)
   → 금광부, 채집꾼, 광부
4. 폴백: 검병 생산
```

### AI 자원 관리

| 행동 | 조건 | 효과 |
|------|------|------|
| 약초 판매 | 약초 ≥ 10 | +30 골드 |
| 전투 유닛 우선 | 지원 유닛 충분 | 70-85% 확률로 전투 유닛 |

---

### 난이도별 예상 게임 양상

| 난이도 | 초반 (0~3분) | 중반 (3~7분) | 후반 (7~10분) |
|--------|-------------|-------------|---------------|
| 쉬움 | 느린 유닛 생산 | 검병 위주 | 소수 궁수 |
| 중간 | 빠른 유닛 생산 | 검병+궁수+채집꾼 혼합 | 기사 대량 등장 |
| 어려움 | 매우 빠른 유닛 생산 | 다양한 유닛 대량 | 기사+궁수 압도적 |

### 난이도별 적 기지 HP

| 난이도 | 적 기지 HP | 공략 난이도 |
|--------|-----------|------------|
| 쉬움 | 1000 | 기본 |
| 중간 | 1200 | +20% |
| 어려움 | 1500 | +50% |

---

## 1vs1 대전 모드

> V1.5.0에서 기본 구조 구현 완료. 상태 동기화 개발 진행중.

### 개요

실시간으로 다른 플레이어와 대전하는 모드입니다.

### 구현 현황

| 기능 | 상태 | 설명 |
|------|------|------|
| WebSocket 서버 | 완료 | Node.js + ws 기반 서버 |
| 플레이어 연결/해제 | 완료 | 연결 관리 및 정리 |
| 매칭 대기열 | 완료 | 2명 매칭 후 게임 방 생성 |
| 게임 방 관리 | 완료 | GameRoom 클래스 구현 |
| 서버 게임 루프 | 완료 | 60fps setInterval 기반 |
| 클라이언트 연동 | 완료 | WebSocket 클라이언트 및 상태 관리 |
| 상태 동기화 | 개발중 | 상대방 상태 표시 안됨 |

### 기술 스택

| 구성요소 | 기술 |
|---------|------|
| 서버 | Node.js |
| 통신 | WebSocket |
| 동기화 | 서버 권위 모델 |

### 아키텍처

```
┌─────────────┐     WebSocket      ┌─────────────┐
│  Player 1   │◄──────────────────►│   Server    │
│  (Browser)  │                    │  (Node.js)  │
└─────────────┘                    └──────┬──────┘
                                          │
                                          │ WebSocket
                                          ▼
                                   ┌─────────────┐
                                   │  Player 2   │
                                   │  (Browser)  │
                                   └─────────────┘
```

### 매칭 시스템

1. 플레이어가 "대전 찾기" 클릭
2. 매칭 대기열에 등록
3. 2명이 모이면 게임 방 생성
4. 카운트다운 후 게임 시작

### 게임 규칙

| 항목 | 값 |
|------|-----|
| 게임 시간 | 10분 |
| 양측 골드 수입 | 4/초 (동일) |
| 초기 자원 | 골드 100 (동일) |
| 승리 조건 | 적 기지 파괴 또는 시간 종료 시 HP 우위 |

### 동기화 전략

**서버 권위 모델**
- 모든 게임 로직은 서버에서 실행
- 클라이언트는 입력만 전송
- 치팅 방지

**상태 동기화**
- 전체 상태: 게임 시작 시
- 델타 업데이트: 100ms마다
- 중요 이벤트: 즉시 전송

### 통신 메시지

**클라이언트 → 서버**
| 메시지 | 설명 |
|--------|------|
| JOIN_QUEUE | 매칭 대기열 참가 |
| LEAVE_QUEUE | 매칭 취소 |
| SPAWN_UNIT | 유닛 생산 요청 |
| BUILD_WALL | 벽 건설 요청 |
| UPGRADE_BASE | 기지 업그레이드 요청 |
| SELL_HERB | 약초 판매 요청 |

**서버 → 클라이언트**
| 메시지 | 설명 |
|--------|------|
| QUEUE_STATUS | 대기열 위치 |
| MATCH_FOUND | 매칭 성공 |
| GAME_STATE | 전체 게임 상태 |
| GAME_UPDATE | 상태 변경분 |
| GAME_OVER | 게임 종료 결과 |

---

## UI 흐름

### 이전 (V1.3.x)

```
메인 메뉴 → [게임 시작] → 게임 화면
```

### 현재 (V1.5.0)

```
메인 메뉴 → [게임 시작] → 모드 선택
                              │
                              ├─ [AI 대전] → 난이도 선택 → 게임 화면
                              │                  │
                              │                  ├─ 쉬움
                              │                  ├─ 중간
                              │                  └─ 어려움
                              │
                              └─ [1vs1 대전] → 로비 화면 → 매칭 대기 → 게임 화면
                                                 │
                                                 ├─ 이름 입력
                                                 ├─ 서버 연결
                                                 └─ 매칭 찾기
```

---

## 알려진 문제

### V1.5.0

| 문제 | 심각도 | 설명 | 해결 방법 |
|------|--------|------|----------|
| 상대방 상태 미표시 | 높음 | 서버 연결 및 매칭은 정상적으로 동작하나, 게임 시작 후 상대방의 유닛/자원/기지 상태가 화면에 표시되지 않음 | 클라이언트의 멀티플레이어 렌더링 로직 구현 필요 |

### 원인 분석

1. **서버 상태 전송**: 서버에서 `GAME_STATE` 메시지로 전체 상태를 브로드캐스트하고 있음
2. **클라이언트 수신**: `useMultiplayerStore`에서 상태를 수신하여 저장하고 있음
3. **렌더링 미연동**: 기존 `useGameStore` 기반 렌더링이 `useMultiplayerStore` 상태를 참조하지 않음

### 해결 계획

1. `GameScreen`에서 멀티플레이어 모드 분기 처리
2. `useMultiplayerStore`의 `gameState`를 렌더링에 사용
3. 상대방 유닛/벽/기지를 캔버스에 렌더링

---

## 다음 문서

- [게임플레이 가이드](./GAMEPLAY.md) - 기본 조작 및 전략
- [유닛 가이드](./UNITS.md) - 모든 유닛의 상세 정보
- [게임 밸런스](./BALANCE.md) - 수치 및 AI 분석
