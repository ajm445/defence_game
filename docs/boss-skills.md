# 보스 스킬 시스템

## 개요

보스는 난이도에 따라 다양한 스킬을 사용합니다. 높은 난이도일수록 더 많은 스킬을 사용하며, 플레이어는 스킬 경고 표시를 보고 회피해야 합니다.

## 난이도별 보스 스킬

| 난이도 | 사용 가능한 스킬 |
|--------|------------------|
| 쉬움 (Easy) | 없음 (기본 공격만) |
| 보통 (Normal) | 강타, 소환 |
| 어려움 (Hard) | 강타, 소환, 밀어내기, 회복 |
| 극한 (Extreme) | 강타, 소환, 충격파, 밀어내기, 돌진, 회복 |

## 스킬 상세

### 1. 강타 (Smash)

전방 부채꼴 범위 공격입니다.

| 속성 | 값 |
|------|-----|
| 쿨다운 | 8초 |
| 데미지 | 보스 공격력의 200% |
| 범위 | 150px 반경 |
| 각도 | 120도 (부채꼴) |
| 시전 시간 | 1초 |
| 스턴 | 0.5초 |

**특징:**
- 시전 중 보스가 멈춤
- 시전 중 보스에게 무적 부여
- 바닥에 주황색 부채꼴 경고 표시

### 2. 소환 (Summon)

졸개 유닛을 소환합니다. **HP 70%부터 쿨타임마다 반복 시전합니다.**

| 속성 | 값 |
|------|-----|
| 쿨다운 | 15초 |
| 소환 수 | 2마리 |
| 시전 시간 | 1.5초 |
| HP 조건 | 70% 이하 |

**소환 특성:**
- HP 70% 도달 시 즉시 최초 시전
- 이후 쿨타임(15초)마다 반복 시전
- 주변에 영웅이 없어도 시전

**소환 유닛 특성:**
- 유형: 기사
- 체력: 기본 기사의 70%
- 공격력: 기본 기사의 80%
- 골드 보상: 15 (낮음)
- 소환 즉시 어그로 활성화

### 3. 충격파 (Shockwave)

전방위 원형 범위 공격입니다.

| 속성 | 값 |
|------|-----|
| 쿨다운 | 20초 |
| 데미지 | 보스 공격력의 150% |
| 범위 | 250px 반경 |
| 시전 시간 | 1.5초 |
| HP 조건 | 50% 이하 |

**특징:**
- 보스 주변 전방위 공격
- 바닥에 빨간색 원형 경고 표시

### 4. 밀어내기 (Knockback)

보스 주변 영웅들을 멀리 밀어냅니다. **HP 50%에서 1회만 사용합니다.**

| 속성 | 값 |
|------|-----|
| 데미지 | 보스 공격력의 50% |
| 범위 | 200px 반경 |
| 밀어내기 거리 | 700px |
| 시전 시간 | 1초 |
| HP 조건 | 50% 이하 |
| 사용 횟수 | **1회** |

**특징:**
- 보스 주변 전방위 넉백
- 영웅이 보스로부터 반대 방향으로 밀려남
- 맵 경계 내로 위치 제한
- 바닥에 노란색 원형 경고 표시
- **HP 50% 도달 시 즉시 1회 시전 후 재사용 불가**

### 5. 돌진 (Charge)

플레이어를 향해 돌진합니다.

| 속성 | 값 |
|------|-----|
| 쿨다운 | 10초 |
| 데미지 | 보스 공격력의 200% |
| 경로 폭 | 50px |
| 돌진 거리 | 300px |
| 시전 시간 | 2초 (기 모으기) |
| HP 조건 | 90% 이하 |

**특징:**
- 가장 가까운 플레이어 방향으로 타겟
- 보스가 멈추고 2초간 기를 모음
- **돌진 경로가 직선으로 고정 표시됨** (파란색)
- 2초 후 경로를 따라 300px 돌진
- 돌진 경로(폭 50px) 내 영웅에게 데미지
- 맵 경계 내로 이동 제한

### 6. 회복 (Heal)

보스가 자신의 체력을 회복합니다.

| 속성 | 값 |
|------|-----|
| 쿨다운 | 60초 |
| 회복량 | 최대 HP의 10% |
| 시전 시간 | 3초 |
| HP 조건 | 60% 이하 |

**특징:**
- HP 60% 도달 시 즉시 시전
- 시전 중 보스가 멈춤 (이동 불가)
- 쿨타임마다 반복 사용 가능
- 경고 표시: 녹색 원형 (회복 이펙트)

## 스킬 시전 흐름

```
1. 스킬 조건 확인 (쿨다운, HP 조건)
2. 스킬 선택 및 시전 시작
3. 경고 표시 생성 (바닥에 범위 표시)
4. 보스 이동 정지 (강타의 경우 무적)
5. 시전 시간 경과
6. 스킬 효과 적용:
   - 강타: 데미지 + 스턴
   - 소환: 졸개 생성
   - 충격파: 범위 데미지
   - 밀어내기: 데미지 + 위치 이동
   - 돌진: 보스 이동 + 경로 데미지
   - 회복: 보스 HP 회복
7. 보스 이동 재개
```

## 경고 표시

스킬 시전 중 바닥에 경고 범위가 표시됩니다.

| 스킬 | 표시 형태 | 색상 |
|------|----------|------|
| 강타 | 부채꼴 | 주황색 |
| 충격파 | 원형 | 빨간색 |
| 소환 | 원형 (소환 위치) | 보라색 |
| 밀어내기 | 원형 | 노란색 |
| 돌진 | 직선 (경로) | 파란색 |
| 회복 | 원형 (보스 주변) | 녹색 |

**경고 표시 특징:**
- 시전 시간 동안 표시
- 깜빡임 효과
- 진행도에 따라 범위가 점점 커짐

## 스킬 선택 우선순위

보스는 다음 우선순위로 스킬을 선택합니다:

1. HP 조건이 만족된 스킬 우선
2. 쿨다운이 완료된 스킬 중 선택
3. 가장 가까운 영웅 방향으로 시전

**HP 조건 스킬 즉시 시전:**
- HP 조건이 있는 스킬은 해당 HP에 도달하는 순간 쿨다운이 즉시 리셋됩니다.
- 예: 보스 HP가 90%가 되면 돌진 스킬이 바로 시전됩니다.
- 예: 보스 HP가 70%가 되면 소환 스킬이 바로 시전됩니다.
- 예: 보스 HP가 60%가 되면 회복 스킬이 바로 시전됩니다.
- 예: 보스 HP가 50%가 되면 밀어내기/충격파 스킬이 바로 시전됩니다.

## 멀티플레이어 동기화

보스 스킬은 호스트-클라이언트 구조로 동기화됩니다.

### 동기화 흐름

```
호스트:
1. 보스 스킬 조건 확인 및 시전 결정
2. bossSkillWarnings 생성 (경고 표시 정보)
3. 스킬 실행 시 bossSkillExecutedEffects 생성 (이펙트 동기화)
4. 게임 상태 직렬화 (warnings + executedEffects 포함)
5. 클라이언트에 브로드캐스트 (50ms 간격)

클라이언트:
1. 게임 상태 수신 및 적용
2. bossSkillWarnings 렌더링 (바닥 경고 표시)
3. bossSkillExecutedEffects 처리 (이펙트/사운드 재생)
```

### 동기화 데이터

| 데이터 | 설명 |
|--------|------|
| `bossSkillWarnings` | 현재 시전 중인 스킬 경고 목록 (바닥 표시용) |
| `bossSkillExecutedEffects` | 스킬 실행 이펙트 (클라이언트 이펙트/사운드 재생용) |
| `gameTime` | 경고 진행도 계산용 게임 시간 |
| `enemies` | 보스 위치/상태 (돌진 후 위치 변경) |
| `hero/otherHeroes` | 영웅 위치 (넉백 후 위치 변경) |

### 스킬 실행 이펙트 동기화 (V1.17.12+)

기존 방식은 클라이언트가 `bossSkillWarnings`의 진행도 95%를 감지하여 이펙트를 재생했으나,
호스트가 스킬 실행 후 경고를 제거하면 클라이언트가 상태를 받을 때 이미 경고가 없어 이펙트가 누락되는 문제가 있었습니다.

**개선된 방식:**
- 호스트가 스킬 실행 시 `bossSkillExecutedEffects` 배열에 이펙트 정보 추가
- 클라이언트가 동기화된 이펙트 배열을 처리하여 이펙트/사운드 재생
- 이펙트는 500ms 후 자동 정리

```typescript
// BossSkillExecutedEffect 인터페이스
interface BossSkillExecutedEffect {
  id: string;           // 고유 ID (중복 방지)
  skillType: BossSkillType;
  x: number;
  y: number;
  timestamp: number;
  healPercent?: number; // 힐 스킬의 경우 회복량 (UI 알림용)
}
```

### 클라이언트 이펙트 처리

클라이언트는 `bossSkillExecutedEffects` 배열에서 새로운 이펙트를 감지하여 재생합니다:

| 스킬 | 이펙트 | 사운드 |
|------|--------|--------|
| 강타 | `boss_smash` | `attack_melee` |
| 충격파 | `boss_shockwave` | `warning` |
| 소환 | `boss_summon` | `boss_spawn` |
| 밀어내기 | `boss_knockback` | `warning` |
| 돌진 | `boss_charge` | `warning` |
| 회복 | `boss_heal` | `hero_revive` |

## 관련 파일

- `src/game/rpg/bossSystem.ts` - 보스 스킬 로직
- `src/constants/rpgConfig.ts` - 스킬 설정값
- `src/renderer/rpgRenderer.ts` - 경고 표시 렌더링
- `src/hooks/useRPGGameLoop.ts` - 클라이언트 이펙트 처리
- `src/stores/useRPGStore.ts` - 상태 직렬화/역직렬화
- `shared/types/hostBasedNetwork.ts` - 네트워크 타입 정의
- `src/types/rpg.ts` - 타입 정의
- `src/effects/particleConfigs.ts` - 파티클 이펙트 설정
