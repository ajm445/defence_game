# 보스 스킬 시스템

## 개요

보스는 난이도에 따라 다양한 스킬을 사용합니다. 높은 난이도일수록 더 많은 스킬을 사용하며, 플레이어는 스킬 경고 표시를 보고 회피해야 합니다.

지옥/종말 난이도에서는 Boss1(근접 보스)과 Boss2(암흑 마법사, 원거리 보스)가 함께 등장합니다 (기지당 2마리, 총 4마리).

## 난이도별 보스 스킬

### Boss1 (보스)

| 난이도 | 사용 가능한 스킬 |
|--------|------------------|
| 쉬움 (Easy) | 없음 (기본 공격만) |
| 보통 (Normal) | 강타, 소환 |
| 어려움 (Hard) | 강타, 소환, 밀어내기, 회복 |
| 극한 (Extreme) | 강타, 소환, 충격파, 밀어내기, 돌진, 회복 |
| 지옥 (Hell) | 강타, 소환, 충격파, 밀어내기, 돌진, 회복 |
| 종말 (Apocalypse) | 강타, 소환, 충격파, 밀어내기, 돌진, 회복 |

### Boss2 (암흑 마법사) — 지옥/종말 전용

| 난이도 | 사용 가능한 스킬 |
|--------|------------------|
| 지옥 (Hell) | 암흑 구체, 그림자 소환, 공허의 영역, 암흑 유성, 영혼 흡수, 순간이동 |
| 종말 (Apocalypse) | 암흑 구체, 그림자 소환, 공허의 영역, 암흑 유성, 영혼 흡수, 순간이동 |

## 보스 스탯 비교

### Boss1 — 난이도별 (1인 기준, 기본 HP 3500 × 배율)

| 난이도 | HP | 공격력 | 공격속도 | 이동속도 |
|--------|------|--------|----------|----------|
| 쉬움 | 3,500 | 100 | 2.0초 | 1.2 |
| 보통 | 7,700 | 160 | 2.0초 | 1.2 |
| 어려움 | 9,800 | 220 | 2.0초 | 1.2 |
| 극한 | 14,000 | 300 | 2.0초 | 1.2 |
| 지옥 | 15,750 | 330 | 2.0초 | 1.2 |
| 종말 | 21,000 | 400 | 2.0초 | 1.2 |

### Boss2 (암흑 마법사) — 난이도/인원별 고정 스탯

**지옥**
| 인원 | HP | 공격력 |
|------|------|--------|
| 1인 | 6,000 | 150 |
| 2인 | 7,000 | 165 |
| 3인 | 9,500 | 195 |
| 4인 | 12,500 | 240 |

**종말**
| 인원 | HP | 공격력 |
|------|------|--------|
| 1인 | 8,500 | 180 |
| 2인 | 9,800 | 200 |
| 3인 | 13,000 | 235 |
| 4인 | 17,000 | 290 |

Boss2 공통: 공격속도 2.5초, 이동속도 1.0, 공격 사거리 250px (원거리), 감지 범위 400px

## Boss1 스킬 상세

### 1. 강타 (Smash)

전방 부채꼴 범위 공격입니다.

| 속성 | 값 |
|------|-----|
| 쿨다운 | 8초 |
| 데미지 | 보스 공격력의 200% |
| 범위 | 150px 반경 |
| 각도 | 120도 (부채꼴) |
| 시전 시간 | 1초 |
| 스턴 | 0.5초 |

**특징:**
- 시전 중 보스가 멈춤
- 시전 중 보스에게 무적 부여
- 바닥에 주황색 부채꼴 경고 표시
- **넥서스에도 데미지 적용**

### 2. 소환 (Summon)

졸개 유닛을 소환합니다. **HP 70%부터 쿨타임마다 반복 시전합니다.**

| 속성 | 값 |
|------|-----|
| 쿨다운 | 15초 |
| 소환 수 | 2마리 |
| 시전 시간 | 1.5초 |
| HP 조건 | 70% 이하 |

**소환 특성:**
- HP 70% 도달 시 즉시 최초 시전
- 이후 쿨타임(15초)마다 반복 시전
- 주변에 영웅이 없어도 시전

**소환 유닛 특성:**
- 유형: 기사
- 체력: 기본 기사의 70%
- 공격력: 기본 기사의 80%
- 골드 보상: 15 (낮음)
- 소환 즉시 어그로 활성화

### 3. 충격파 (Shockwave)

전방위 원형 범위 **즉사** 공격입니다. 넥서스에는 데미지를 주지 않습니다.

| 속성 | 값 |
|------|-----|
| 쿨다운 | 20초 |
| 데미지 | **즉사** (캐릭터에게만) |
| 범위 | 250px 반경 |
| 시전 시간 | 1.5초 |
| HP 조건 | 50% 이하 |

**특징:**
- 보스 주변 전방위 즉사 공격 (넥서스 데미지 없음)
- 바닥에 빨간색 원형 경고 표시 + **"⚠ 즉사 충격파 ⚠" 경고 메시지**
- 범위 밖으로 이동해야 생존 가능

### 4. 밀어내기 (Knockback)

보스 주변 영웅들을 멀리 밀어냅니다. **HP 50%에서 1회만 사용합니다.** 데미지는 없습니다.

| 속성 | 값 |
|------|-----|
| 데미지 | 없음 |
| 범위 | 200px 반경 |
| 밀어내기 거리 | 700px |
| 시전 시간 | 1초 |
| HP 조건 | 50% 이하 |
| 사용 횟수 | **1회** |

**특징:**
- 보스 주변 전방위 넉백 (데미지 없음, 넥서스 영향 없음)
- 영웅이 보스로부터 반대 방향으로 밀려남
- 맵 경계 내로 위치 제한
- 바닥에 노란색 원형 경고 표시
- **HP 50% 도달 시 즉시 1회 시전 후 재사용 불가**

### 5. 돌진 (Charge)

플레이어를 향해 돌진합니다.

| 속성 | 값 |
|------|-----|
| 쿨다운 | 10초 |
| 데미지 | 보스 공격력의 200% |
| 경로 폭 | 50px |
| 돌진 거리 | 300px |
| 시전 시간 | 2초 (기 모으기) |
| HP 조건 | 90% 이하 |

**특징:**
- 가장 가까운 플레이어 방향으로 타겟
- 보스가 멈추고 2초간 기를 모음
- **돌진 경로가 직선으로 고정 표시됨** (파란색)
- 2초 후 경로를 따라 300px 돌진
- 돌진 경로(폭 50px) 내 영웅에게 데미지
- **넥서스에도 데미지 적용** (경로에 넥서스가 있는 경우)
- 맵 경계 내로 이동 제한

### 6. 회복 (Heal)

보스가 자신의 체력을 회복합니다.

| 속성 | 값 |
|------|-----|
| 쿨다운 | 60초 |
| 회복량 | 최대 HP의 10% |
| 시전 시간 | 3초 |
| HP 조건 | 60% 이하 |

**특징:**
- HP 60% 도달 시 즉시 시전
- 시전 중 보스가 멈춤 (이동 불가)
- 쿨타임마다 반복 사용 가능
- 경고 표시: 녹색 원형 (회복 이펙트)

## Boss2 스킬 상세 (암흑 마법사) — 지옥/종말 전용

### 1. 암흑 구체 (Dark Orb)

대상 방향으로 원거리 AoE 폭발을 발사합니다.

| 속성 | 값 |
|------|-----|
| 쿨다운 | 6초 |
| 데미지 | 공격력의 250% |
| 범위 | 120px 반경 |
| 시전 시간 | 1초 |
| HP 조건 | 없음 |

**특징:**
- Boss2의 주력 스킬 (가장 짧은 쿨타임)
- 조건 없이 항시 사용 가능

### 2. 그림자 소환 (Shadow Summon)

마법사 졸개를 소환합니다.

| 속성 | 값 |
|------|-----|
| 쿨다운 | 18초 |
| 소환 수 | 3마리 |
| 시전 시간 | 1.5초 |
| HP 조건 | 70% 이하 |

**특징:**
- Boss1 소환(2마리)보다 1마리 더 많음
- HP 70% 도달 시 즉시 시전 후 쿨타임마다 반복

### 3. 공허의 영역 (Void Zone)

지속 데미지 장판을 생성합니다.

| 속성 | 값 |
|------|-----|
| 쿨다운 | 15초 |
| 데미지 | 공격력의 50%/초 |
| 범위 | 180px 반경 |
| 시전 시간 | 1.5초 |
| 지속 시간 | 5초 |
| HP 조건 | 없음 |

**특징:**
- 조건 없이 사용 가능한 광역 장판
- 보라색 소용돌이 렌더링
- 장판 위에 서 있으면 매초 데미지

### 4. 암흑 유성 (Dark Meteor)

각 영웅 위치에 유성을 낙하시킵니다.

| 속성 | 값 |
|------|-----|
| 쿨다운 | 20초 |
| 데미지 | 공격력의 300% |
| 범위 | 100px 반경 |
| 시전 시간 | 2초 |
| HP 조건 | 50% 이하 |

**특징:**
- **모든 영웅 위치에 동시 낙하** (회피 필수)
- 가장 높은 단일 데미지 (300%)
- 시전 시간이 2초로 길어 회피 가능

### 5. 영혼 흡수 (Soul Drain)

주변 영웅의 생명력을 흡수하여 자신을 회복합니다.

| 속성 | 값 |
|------|-----|
| 쿨다운 | 12초 |
| 데미지 | 공격력의 150% |
| 범위 | 200px 반경 |
| 시전 시간 | 1.5초 |
| HP 조건 | 60% 이하 |
| 자힐 | 적중 영웅당 최대 HP의 5% |

**특징:**
- 공격과 회복을 동시에 수행
- 영웅이 많이 모여있을수록 회복량 증가
- 범위 밖으로 이동하여 회복 차단 가능

### 6. 순간이동 (Teleport)

가장 먼 영웅 근처로 텔레포트합니다.

| 속성 | 값 |
|------|-----|
| 쿨다운 | 10초 |
| 데미지 | 없음 |
| 시전 시간 | 0.8초 |
| HP 조건 | 80% 이하 |

**특징:**
- 가장 빠른 시전 (0.8초)
- 데미지는 없지만 원거리 딜러에게 기습적으로 접근
- HP 80% 이하에서 가장 먼저 해금되는 스킬

### Boss2 HP 조건 해금 순서

| HP 도달 | 해금 스킬 |
|---------|----------|
| 80% | 순간이동 |
| 70% | 그림자 소환 |
| 60% | 영혼 흡수 |
| 50% | 암흑 유성 |
| — | 암흑 구체, 공허의 영역 (항시 사용) |

## 스킬 시전 흐름

```
1. 스킬 조건 확인 (쿨다운, HP 조건)
2. 스킬 선택 및 시전 시작
3. 경고 표시 생성 (바닥에 범위 표시)
4. 보스 이동 정지 (강타의 경우 무적)
5. 시전 시간 경과
6. 스킬 효과 적용:
   Boss1:
   - 강타: 데미지 + 스턴
   - 소환: 졸개 생성
   - 충격파: 범위 즉사
   - 밀어내기: 넉백
   - 돌진: 보스 이동 + 경로 데미지
   - 회복: 보스 HP 회복
   Boss2:
   - 암흑 구체: AoE 폭발 데미지
   - 그림자 소환: 마법사 졸개 3마리
   - 공허의 영역: 5초 지속 장판
   - 암흑 유성: 각 영웅 위치 낙하
   - 영혼 흡수: AoE 드레인 + 자힐
   - 순간이동: 위치 이동
7. 보스 이동 재개
```

## 경고 표시

스킬 시전 중 바닥에 경고 범위가 표시됩니다.

### Boss1 경고

| 스킬 | 표시 형태 | 색상 |
|------|----------|------|
| 강타 | 부채꼴 | 주황색 |
| 충격파 | 원형 | 빨간색 |
| 소환 | 원형 (소환 위치) | 보라색 |
| 밀어내기 | 원형 | 노란색 |
| 돌진 | 직선 (경로) | 파란색 |
| 회복 | 원형 (보스 주변) | 녹색 |

### Boss2 경고

| 스킬 | 표시 형태 | 색상 |
|------|----------|------|
| 암흑 구체 | 원형 | 보라색 |
| 그림자 소환 | 원형 | 보라색 |
| 공허의 영역 | 원형 (지속 장판) | 보라색 소용돌이 |
| 암흑 유성 | 원형 (각 영웅 위치) | 보라색 |
| 영혼 흡수 | 원형 | 보라색 |
| 순간이동 | 없음 | — |

**경고 표시 특징:**
- 시전 시간 동안 표시
- 깜빡임 효과
- 진행도에 따라 범위가 점점 커짐

## 스킬 선택 우선순위

보스는 다음 우선순위로 스킬을 선택합니다:

1. HP 조건이 만족된 스킬 우선
2. 쿨다운이 완료된 스킬 중 선택
3. 가장 가까운 영웅 방향으로 시전

**HP 조건 스킬 즉시 시전:**
- HP 조건이 있는 스킬은 해당 HP에 도달하는 순간 쿨다운이 즉시 리셋됩니다.
- 예: 보스 HP가 90%가 되면 돌진 스킬이 바로 시전됩니다.
- 예: 보스 HP가 70%가 되면 소환 스킬이 바로 시전됩니다.
- 예: 보스 HP가 60%가 되면 회복 스킬이 바로 시전됩니다.
- 예: 보스 HP가 50%가 되면 밀어내기/충격파 스킬이 바로 시전됩니다.

## 멀티플레이어 동기화

보스 스킬은 호스트-클라이언트 구조로 동기화됩니다.

### 동기화 흐름

```
호스트:
1. 보스 스킬 조건 확인 및 시전 결정
2. bossSkillWarnings 생성 (경고 표시 정보)
3. 스킬 실행 시 bossSkillExecutedEffects 생성 (이펙트 동기화)
4. 게임 상태 직렬화 (warnings + executedEffects 포함)
5. 클라이언트에 브로드캐스트 (50ms 간격)

클라이언트:
1. 게임 상태 수신 및 적용
2. bossSkillWarnings 렌더링 (바닥 경고 표시)
3. bossSkillExecutedEffects 처리 (이펙트/사운드 재생)
```

### 동기화 데이터

| 데이터 | 설명 |
|--------|------|
| `bossSkillWarnings` | 현재 시전 중인 스킬 경고 목록 (바닥 표시용) |
| `bossSkillExecutedEffects` | 스킬 실행 이펙트 (클라이언트 이펙트/사운드 재생용) |
| `gameTime` | 경고 진행도 계산용 게임 시간 |
| `enemies` | 보스 위치/상태 (돌진 후 위치 변경) |
| `hero/otherHeroes` | 영웅 위치 (넉백 후 위치 변경) |

### 스킬 실행 이펙트 동기화 (V1.17.12+)

기존 방식은 클라이언트가 `bossSkillWarnings`의 진행도 95%를 감지하여 이펙트를 재생했으나,
호스트가 스킬 실행 후 경고를 제거하면 클라이언트가 상태를 받을 때 이미 경고가 없어 이펙트가 누락되는 문제가 있었습니다.

**개선된 방식:**
- 호스트가 스킬 실행 시 `bossSkillExecutedEffects` 배열에 이펙트 정보 추가
- 클라이언트가 동기화된 이펙트 배열을 처리하여 이펙트/사운드 재생
- 이펙트는 500ms 후 자동 정리

```typescript
// BossSkillExecutedEffect 인터페이스
interface BossSkillExecutedEffect {
  id: string;           // 고유 ID (중복 방지)
  skillType: BossSkillType;
  x: number;
  y: number;
  timestamp: number;
  healPercent?: number; // 힐 스킬의 경우 회복량 (UI 알림용)
}
```

### 클라이언트 이펙트 처리

클라이언트는 `bossSkillExecutedEffects` 배열에서 새로운 이펙트를 감지하여 재생합니다:

| 스킬 | 이펙트 | 사운드 |
|------|--------|--------|
| 강타 | `boss_smash` | `attack_melee` |
| 충격파 | `boss_shockwave` | `warning` |
| 소환 | `boss_summon` | `boss_spawn` |
| 밀어내기 | `boss_knockback` | `warning` |
| 돌진 | `boss_charge` | `warning` |
| 회복 | `boss_heal` | `hero_revive` |
| 암흑 구체 | `boss_dark_orb` | `warning` |
| 그림자 소환 | `boss_shadow_summon` | `boss_spawn` |
| 공허의 영역 | `boss_void_zone` | `warning` |
| 암흑 유성 | `dark_meteor_fall` (SkillEffect) | `warning` |
| 영혼 흡수 | `boss_soul_drain` | `warning` |
| 순간이동 | `boss_teleport` | — |

## 관련 파일

- `server/src/game/rpgServerBossSystem.ts` - 서버 보스 스킬 로직 (Boss1 + Boss2)
- `server/src/game/rpgServerConfig.ts` - 서버 스킬 설정값
- `server/src/game/rpgServerEnemySystem.ts` - 보스 생성 (createBoss, createBoss2)
- `server/src/utils/bossUtils.ts` - `isBossType()` 유틸리티
- `src/constants/rpgConfig.ts` - 클라이언트 스킬 설정값
- `src/renderer/rpgRenderer.ts` - 경고 표시 렌더링 (Boss2 보라색 테마)
- `src/renderer/drawHero.ts` - Boss2 렌더링 (보라색 글로우)
- `src/hooks/useRPGGameLoop.ts` - 클라이언트 이펙트 처리
- `src/stores/useRPGStore.ts` - 상태 직렬화/역직렬화
- `src/utils/bossUtils.ts` - 클라이언트 `isBossType()` 유틸리티
- `shared/types/hostBasedNetwork.ts` - 네트워크 타입 정의
- `src/types/rpg.ts` - 타입 정의 (BossSkillType, BossVoidZone 등)
- `src/effects/particleConfigs.ts` - 파티클 이펙트 설정
